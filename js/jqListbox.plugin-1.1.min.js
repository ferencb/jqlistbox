!function(t){"use strict";function e(e,i){this.el=e,this.$el=t(e),this.options=t.extend({},t.fn[s].defaults,i),this.init()}var s="jqListbox";t.fn[s]=function(i){var n,o=arguments;if(void 0===i||"object"==typeof i)return this.each(function(){t.data(this,"plugin_"+s)||t.data(this,"plugin_"+s,new e(t(this),i))});if(1===this.length&&(n=t.data(this[0],"plugin_"+s))instanceof e){if("function"==typeof n[i])return n[i].apply(n,Array.prototype.slice.call(o,1));if(n.options.hasOwnProperty(i)){if(1===o.length)return n.options[i];n.options[i]=o[1]}}},t.fn[s].defaults={itemSelector:"li",targetInput:"#listbox-value",initialValues:!1,initialEncodedValues:!1,selectedClass:"selected",autoSelectOnClick:!0,multiselect:!0,itemRenderer:function(t,e,s){return"<li>"+t+"</li>"},listboxValueEncoder:function(t){return JSON.stringify(t)},listboxValueDecoder:function(t){return t.length>0?JSON.parse(t):[]},onBeforeInit:!1,onAfterInit:!1,onBeforeItemInsert:!1,onAfterItemInsert:!1,onBeforeItemUpdate:!1,onAfterItemUpdate:!1,onBeforeItemRemove:!1,onAfterItemRemove:!1,onBeforeClear:!1,onAfterClear:!1,onChanged:!1,onBeforeRender:!1,onAfterRender:!1},e.prototype={items:[],selectedPositions:[],init:function(){"function"==typeof this.options.onBeforeInit&&this.options.onBeforeInit.apply(this.$el,[this]),this.items=[],this.selectedPositions=[],this.initItems(),this.options.autoSelectOnClick&&this.setupAutoClickHandler(),this.render(),"function"==typeof this.options.onAfterInit&&this.options.onAfterInit.apply(this.$el,[this])},setupAutoClickHandler:function(){var e=this;this.$el.on("click",this.options.itemSelector,function(s){var i=t(this).index();return e.isSelected(i)?e.deselect(i):e.select(i),s.preventDefault(),!1})},reset:function(){this.clear(),this.initItems(),this.render()},initItems:function(){!1!==this.options.initialValues?this.setFromArray(this.options.initialValues):!1!==this.options.initialEncodedValues?this.setFromTargetValue(this.options.initialEncodedValues):!1!==this.options.targetInput&&1===t(this.options.targetInput).length&&this.setFromTargetValue(t(this.options.targetInput).val())},getItemByIndex:function(t){return this.items[t]},testOnChanged:function(t){"function"==typeof this.options.onChanged&&this.options.onChanged.apply(this.$el,[t,this])},testOnBeforeItemInsert:function(t){var e,s=t;return"function"==typeof this.options.onBeforeItemInsert&&void 0!==(e=this.options.onBeforeItemInsert.apply(this.$el,[t,this]))&&(s=e),s},testOnAfterItemInsert:function(t){"function"==typeof this.options.onAfterItemInsert&&this.options.onAfterItemInsert.apply(this.$el,[t,this])},testOnBeforeItemUpdate:function(t,e){var s,i=e;return"function"==typeof this.options.onBeforeItemUpdate&&void 0!==(s=this.options.onBeforeItemUpdate.apply(this.$el,[t,e,this]))&&(i=s),i},testOnAfterItemUpdate:function(t,e){"function"==typeof this.options.onAfterItemUpdate&&this.options.onAfterItemUpdate.apply(this.$el,[t,e,this])},testOnBeforeItemRemove:function(t){var e,s=t;return"function"==typeof this.options.onBeforeItemRemove&&void 0!==(e=this.options.onBeforeItemRemove.apply(this.$el,[t,this]))&&(s=e),s},testOnAfterItemRemove:function(){"function"==typeof this.options.onAfterItemRemove&&this.options.onAfterItemRemove.apply(this.$el,[this])},insert:function(t){var e=this.testOnBeforeItemInsert([t]);return!1!==e&&0!==e.length&&(t=e[0],this.items.push(t),this.render(),this.testOnAfterItemInsert([t]),this.testOnChanged("insert")),this.items.length},insertAt:function(t,e){if(e===this.items.length)return this.insert(t);var s=this.testOnBeforeItemInsert([t]);return!1!==s&&0!==s.length&&(t=s[0],this.items.splice(e,0,t),this.render(),this.testOnAfterItemInsert([t]),this.testOnChanged("insert")),this.items.length},insertMulti:function(t){var e=this.testOnBeforeItemInsert(t);return!1!==e&&0!==e.length&&(t=e,this.items=this.items.concat(t),this.render(),this.testOnAfterItemInsert(t),this.testOnChanged("insert")),this.items.length},insertMultiAt:function(t,e){if(e===this.items.length)return this.insertMulti(t);var s=this.testOnBeforeItemInsert(t);return!1!==s&&0!==s.length&&(t=s,this.items.splice.apply(this.items,[e,0].concat(t)),this.render(),this.testOnAfterItemInsert(t),this.testOnChanged("insert")),this.items.length},update:function(t){var e;if(this.selectedPositions.length>0&&!1!==(t=this.testOnBeforeItemUpdate(this.getSelectedItems(),[t]))){for(t=t[0],e=0;e<this.selectedPositions.length;e++)this.items[this.selectedPositions[e]]=t;this.render(),this.testOnAfterItemUpdate(this.getSelectedItems(),t),this.testOnChanged("update")}return this.selectedPositions.length},updateMulti:function(t){var e,s=0,i={};if(this.selectedPositions.length>0&&t.length>0&&!1!==(t=this.testOnBeforeItemUpdate(this.getSelectedItems(),t))){for(e=0;e<this.selectedPositions.length;e++)i=t[s],this.items[this.selectedPositions[e]]=i,++s>=t.length&&(s=0);this.render(),this.testOnAfterItemUpdate(this.getSelectedItems(),t),this.testOnChanged("update")}return this.selectedPositions.length},updateAt:function(t,e){if(e<0&&(e=this.items.length+e),e>=0&&e<this.items.length)return!1===(t=this.testOnBeforeItemUpdate([this.getItemByIndex(e)],[t]))?this.getItemByIndex(e):(t=t[0],this.items[e]=t,this.render(),this.testOnAfterItemUpdate(this.getItemByIndex(e),[t]),this.testOnChanged("update"),t)},remove:function(){var t,e,s=[],i=[],n=0;if(this.selectedPositions.length>0&&!1!==(t=this.testOnBeforeItemRemove(this.selectedPositions))&&0!==t.length){for(n=0;n<this.items.length;n++)e=parseInt(n,10),-1===t.indexOf(e)&&(s.push(this.items[e]),-1!==this.selectedPositions.indexOf(e)&&i.push(s.length));this.items=s.slice(),this.selectedPositions=i.slice(),this.render(),this.testOnAfterItemRemove(),this.testOnChanged("remove")}return this.items.length},removeByIndex:function(t){var e,s=this.testOnBeforeItemRemove([t]);return!1!==s&&1===s.length&&((e=this.selectedPositions.indexOf(t))>-1&&this.selectedPositions.splice(e,-1),this.items.splice(t,1),this.render(),this.testOnAfterItemRemove(),this.testOnChanged("remove")),this.items.length},clear:function(){if("function"==typeof this.options.onBeforeClear&&!1===this.options.onBeforeClear.apply(this.$el,[this]))return!1;this.items=[],this.selectedPositions=[],this.render(),"function"==typeof this.options.onAfterClear&&this.options.onAfterClear.apply(this.$el,[this]),this.testOnChanged("clear")},moveup:function(){var t,e;if(this.selectedPositions.length>0){if(0===this.selectedPositions[0])this.shiftElementsUp();else if(1===this.selectedPositions.length)this.switchElements(this.selectedPositions[0],this.selectedPositions[0]-1);else for(e=this.selectedPositions.slice(),t=0;t<e.length;t++)this.switchElements(e[t],e[t]-1);this.render(),this.testOnChanged("moveup")}},moveupByIndex:function(t){t<this.items.length&&(0===t?this.shiftElementsUp():this.switchElements(t,t-1),this.render(),this.testOnChanged("moveup"))},movedown:function(){var t,e;if(this.selectedPositions.length>0){if(this.selectedPositions[this.selectedPositions.length-1]===this.items.length-1)this.shiftElementsDown();else if(1===this.selectedPositions.length)this.switchElements(this.selectedPositions[0],this.selectedPositions[0]+1);else for((e=this.selectedPositions.slice()).reverse(),t=0;t<e.length;t++)this.switchElements(e[t],e[t]+1);this.render(),this.testOnChanged("movedown")}},movedownByIndex:function(t){t<this.items.length&&(t===this.items.length-1?this.shiftElementsDown():this.switchElements(t,t+1),this.render(),this.testOnChanged("movedown"))},switchElements:function(t,e){var s,i,n;t!==e&&(n=this.items[t],this.items[t]=this.items[e],this.items[e]=n,s=this.selectedPositions.indexOf(t),i=this.selectedPositions.indexOf(e),(-1!==s&&-1===i||-1===s&&-1!==i)&&(-1!==s&&(this.selectedPositions.splice(s,1),this.selectedPositions.push(e)),-1!==i&&(this.selectedPositions.splice(i,1),this.selectedPositions.push(t))),this.selectedPositions.sort())},shiftElementsUp:function(){var t,e,s=0;if(this.items.length>0&&((t=this.items.slice(1)).push(this.items[0]),this.items=t.slice(),this.selectedPositions.length>0)){for(e=[],s=0;s<this.selectedPositions.length;s++)0===this.selectedPositions[s]?e.push(this.items.length-1):e.push(this.selectedPositions[s]-1);this.selectedPositions=e.slice(),this.selectedPositions.sort()}},shiftElementsDown:function(){var t,e=[],s=0;if(this.items.length>0&&(t=[this.items.pop()].concat(this.items.slice()),this.items=t.slice(),this.selectedPositions.length>0)){for(e=[],this.selectedPositions[this.selectedPositions.length-1]===this.items.length-1?e.push(0):e.push(this.selectedPositions[this.selectedPositions.length-1]+1),s=0;s<this.selectedPositions.length-1;s++)e.push(this.selectedPositions[s]+1);this.selectedPositions=e.slice(),this.selectedPositions.sort()}},transferSelectedTo:function(t,e){if(this.countSelected()>0){var s=this.getSelectedItems(),i=0;for(i=0;i<s.length;i++)t.jqListbox("insert",s[i]);!0!==e&&this.remove()}},transferByIndexTo:function(t,e,s){e>=0&&e<this.count()&&(t.jqListbox("insert",this.getItemByIndex(e)),!0!==s&&this.removeByIndex(e))},transferByIndexMultiTo:function(t,e,s){if(e.length>0){e.sort(function(t,e){return t-e});var i;if(!0!==s)for(i=0;i<e.length;i++)t.jqListbox("insert",this.getItemByIndex(e[i]-i)),this.removeByIndex(e[i]-i);else for(i=0;i<e.length;i++)t.jqListbox("insert",this.getItemByIndex(e[i]))}},getTargetValue:function(){return this.options.listboxValueEncoder(this.items)},getAsArray:function(){return this.items},setFromArray:function(t){return this.items=t.slice(),this.items.length},setFromTargetValue:function(t){var e=this.options.listboxValueDecoder.apply(this.$el,[t]);return this.setFromArray(e),this.items.length},count:function(){return this.items.length},countSelected:function(){return this.selectedPositions.length},select:function(t){-1===this.selectedPositions.indexOf(t)&&t<this.items.length&&(!1===this.options.multiselect&&this.selectedPositions.length>0&&(this.selectedPositions=[]),this.selectedPositions.push(t),this.selectedPositions.sort(),this.render())},deselect:function(t){var e=this.selectedPositions.indexOf(t);e>-1&&(this.selectedPositions.splice(e,1),this.render())},selectAll:function(){var t;if(!0===this.options.multiselect){for(this.selectedPositions=[],t=0;t<this.items.length;t++)this.selectedPositions.push(t);this.selectedPositions.sort(),this.render()}},deselectAll:function(){this.selectedPositions=[],this.render()},getSelected:function(){return this.selectedPositions},isSelected:function(t){return-1!==this.selectedPositions.indexOf(t)},getSelectedItems:function(){return this.items.filter(function(t,e,s){return this.selectedPositions.indexOf(e)>-1},this)},getSelectedJQueryItems:function(){var t=this;return this.$el.find(this.options.itemSelector).filter(function(e,s){return t.selectedPositions.indexOf(e)>-1})},getJQueryItemByIndex:function(t){return this.$el.find(this.options.itemSelector).eq(t)},render:function(){var e,s,i,n;if("function"==typeof this.options.onBeforeRender&&!1===this.options.onBeforeRender.apply(this.$el,[this]))return!1;for(e=this.getTargetValue(),!1!==this.options.targetInput&&t(this.options.targetInput).val(e),this.$el.empty(),s=0;s<this.items.length;s++)s=parseInt(s,10),i=this.options.itemRenderer.apply(this.$el,[this.items[s],parseInt(s,10),this]),n=t(i).appendTo(this.$el),!1!==this.options.selectedClass&&this.isSelected(s)&&n.addClass(this.options.selectedClass);"function"==typeof this.options.onAfterRender&&this.options.onAfterRender.apply(this.$el,[this])},itemWalk:function(t){var e;if(this.items.length>0)for(e=0;e<this.items.length;e++)t.apply(this.$el,[this.items[e],e,this.$el.find(this.options.itemSelector).eq(e),this])},selectedWalk:function(t){var e,s,i;if(this.selectedPositions.length>0)for(e=this.$el.find(this.options.itemSelector),s=0;s<this.selectedPositions.length;s++)i=this.selectedPositions[s],t.apply(this.$el,[this.items[i],i,e.eq(i),this])}}}(jQuery);
